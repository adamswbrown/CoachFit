generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model CoachInvite {
  id        String   @id @default(uuid())
  email     String
  coachId   String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@unique([email, coachId])
  @@index([coachId])
  @@index([email])
}

model Cohort {
  id                        String                         @id @default(uuid())
  name                      String
  coachId                   String
  createdAt                 DateTime                       @default(now())
  cohortStartDate           DateTime?                      @db.Date // Week 1 start date for questionnaire tracking
  durationConfig            String                         @default("six-week") // "six-week" or "custom"
  durationWeeks             Int?                           // Weeks duration (6 for six-week, or custom value)
  coachMemberships          CoachCohortMembership[]
  User                      User                           @relation(fields: [coachId], references: [id], onDelete: Cascade)
  CheckInConfig             CohortCheckInConfig?
  invites                   CohortInvite[]
  memberships               CohortMembership[]
  questionnaireBundle       QuestionnaireBundle?
  weeklyQuestionnaireResponses WeeklyQuestionnaireResponse[]

  @@unique([coachId, name])
  @@index([coachId])
  @@index([createdAt])
}

model CoachCohortMembership {
  coachId  String
  cohortId String
  addedAt  DateTime @default(now())
  User     User     @relation(fields: [coachId], references: [id], onDelete: Cascade)
  Cohort   Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@id([coachId, cohortId])
  @@index([coachId])
  @@index([cohortId])
}

model CohortInvite {
  id        String   @id @default(uuid())
  email     String
  cohortId  String
  createdAt DateTime @default(now())
  Cohort    Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@unique([email, cohortId])
  @@index([cohortId])
  @@index([email])
}

model CohortMembership {
  userId   String
  cohortId String
  Cohort   Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, cohortId])
  @@index([userId])
  @@index([cohortId])
}

model Entry {
  id                String   @id @default(uuid())
  userId            String
  date              DateTime @db.Date
  weightLbs         Float?
  steps             Int?
  calories          Int?
  createdAt         DateTime @default(now())
  heightInches      Float?
  updatedAt         DateTime @updatedAt
  sleepQuality      Int?
  perceivedStress   Int?
  notes             String?
  customResponses   Json?
  dataSources       Json?    @default("[]")
  bodyFatPercentage Float?
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@index([date])
}

model Workout {
  id             String   @id @default(uuid())
  userId         String
  workoutType    String
  startTime      DateTime
  endTime        DateTime
  durationSecs   Int
  caloriesActive Int?
  distanceMeters Float?
  avgHeartRate   Int?
  maxHeartRate   Int?
  sourceDevice   String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, startTime])
  @@index([startTime])
}

model SleepRecord {
  id             String    @id @default(uuid())
  userId         String
  date           DateTime  @db.Date
  totalSleepMins Int
  inBedMins      Int?
  awakeMins      Int?
  asleepCoreMins Int?
  asleepDeepMins Int?
  asleepREMMins  Int?
  sleepStart     DateTime?
  sleepEnd       DateTime?
  sourceDevices  Json?     @default("[]")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  User           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([userId, date])
  @@index([date])
}

model PairingCode {
  id        String    @id @default(uuid())
  code      String    @unique
  coachId   String
  clientId  String?
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  Client    User?     @relation("ClientPairingCodes", fields: [clientId], references: [id])
  Coach     User      @relation("CoachPairingCodes", fields: [coachId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([coachId])
  @@index([expiresAt])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                     String                           @id @default(uuid())
  email                  String                           @unique
  name                   String?
  image                  String?
  passwordHash           String?
  mustChangePassword     Boolean                          @default(false)
  roles                  Role[]                           @default([CLIENT])
  isTestUser             Boolean                          @default(false)
  emailVerified          DateTime?
  createdAt              DateTime                         @default(now())
  invitedByCoachId       String?
  onboardingComplete     Boolean                          @default(false)
  gender                 String?
  dateOfBirth            DateTime?                        @db.Date
  activityLevel          String?
  primaryGoal            String?
  Account                Account[]
  AdminActions           AdminAction[]                    @relation("AdminActions")
  CoachCohortMembership  CoachCohortMembership[]
  CoachInvite            CoachInvite[]
  ClientNotes            CoachNote[]                      @relation("ClientNotes")
  CoachNotes             CoachNote[]                      @relation("CoachNotes")
  ClientWeeklyResponses  WeeklyCoachResponse[]            @relation("ClientWeeklyResponses")
  CoachWeeklyResponses   WeeklyCoachResponse[]            @relation("CoachWeeklyResponses")
  Cohort                 Cohort[]
  CohortMembership       CohortMembership[]
  Entry                  Entry[]
  ClientPairingCodes     PairingCode[]                    @relation("ClientPairingCodes")
  CoachPairingCodes      PairingCode[]                    @relation("CoachPairingCodes")
  Session                Session[]
  SleepRecords           SleepRecord[]
  User                   User?                            @relation("UserToUser", fields: [invitedByCoachId], references: [id])
  other_User             User[]                           @relation("UserToUser")
  UserConsent            UserConsent?
  UserGoals              UserGoals?
  UserPreference         UserPreference?
  Workouts               Workout[]
  WeeklyQuestionnaireResponses WeeklyQuestionnaireResponse[]

  @@index([invitedByCoachId])
  @@index([createdAt])
  @@index([roles])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model CoachNote {
  id        String   @id @default(uuid())
  coachId   String
  clientId  String
  weekStart DateTime @db.Date
  note      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  noteDate  DateTime @db.Date
  client    User     @relation("ClientNotes", fields: [clientId], references: [id], onDelete: Cascade)
  coach     User     @relation("CoachNotes", fields: [coachId], references: [id], onDelete: Cascade)

  @@unique([coachId, clientId, weekStart])
  @@index([coachId, clientId])
  @@index([noteDate])
}

model WeeklyCoachResponse {
  id        String   @id @default(uuid())
  coachId   String
  clientId  String
  weekStart DateTime @db.Date
  loomUrl   String?
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  client    User     @relation("ClientWeeklyResponses", fields: [clientId], references: [id], onDelete: Cascade)
  coach     User     @relation("CoachWeeklyResponses", fields: [coachId], references: [id], onDelete: Cascade)

  @@unique([coachId, clientId, weekStart])
  @@index([coachId, clientId])
  @@index([weekStart])
}

model CohortCheckInConfig {
  id                String   @id @default(uuid())
  cohortId          String   @unique
  enabledPrompts    String[]
  customPrompt1     String?
  customPrompt1Type String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  cohort            Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@index([cohortId])
}

model AdminInsight {
  id          String    @id @default(uuid())
  entityType  String
  entityId    String
  insightType String
  category    String
  title       String
  description String
  severity    String    @default("info")
  priority    String    @default("green")
  actionable  Boolean   @default(true)
  metadata    Json?
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?

  @@index([entityType, entityId])
  @@index([priority, createdAt])
  @@index([insightType, severity])
  @@index([createdAt])
}

model AttentionScore {
  id           String    @id @default(uuid())
  entityType   String
  entityId     String
  priority     String
  score        Int
  reasons      String[]
  metadata     Json?
  calculatedAt DateTime  @default(now())
  expiresAt    DateTime?

  @@unique([entityType, entityId])
  @@index([priority, score])
  @@index([calculatedAt])
}

model AdminAction {
  id         String   @id @default(uuid())
  adminId    String
  actionType String
  targetType String
  targetId   String?
  details    Json?
  reason     String?
  insightId  String?
  createdAt  DateTime @default(now())
  admin      User     @relation("AdminActions", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([actionType])
  @@index([createdAt])
  @@index([insightId])
}

model SystemSettings {
  id                       String   @id @default(uuid())
  maxClientsPerCoach       Int      @default(50)
  minClientsPerCoach       Int      @default(10)
  recentActivityDays       Int      @default(14)
  lowEngagementEntries     Int      @default(7)
  noActivityDays           Int      @default(14)
  criticalNoActivityDays   Int      @default(30)
  shortTermWindowDays      Int      @default(7)
  longTermWindowDays       Int      @default(30)
  adminOverrideEmail       String?
  healthkitEnabled         Boolean  @default(true)
  iosIntegrationEnabled    Boolean  @default(true)
  adherenceGreenMinimum    Int      @default(6)
  adherenceAmberMinimum    Int      @default(3)
  bodyFatLowPercent        Float    @default(12.5)
  bodyFatMediumPercent     Float    @default(20.0)
  bodyFatHighPercent       Float    @default(30.0)
  bodyFatVeryHighPercent   Float    @default(37.5)
  minDailyCalories         Int      @default(1000)
  maxDailyCalories         Int      @default(5000)
  minProteinPerLb          Float    @default(0.4)
  maxProteinPerLb          Float    @default(2.0)
  defaultCarbsPercent      Float    @default(40.0)
  defaultProteinPercent    Float    @default(30.0)
  defaultFatPercent        Float    @default(30.0)
  stepsNotMuch             Int      @default(5000)
  stepsLight               Int      @default(7500)
  stepsModerate            Int      @default(10000)
  stepsHeavy               Int      @default(12500)
  workoutNotMuch           Int      @default(75)
  workoutLight             Int      @default(150)
  workoutModerate          Int      @default(225)
  workoutHeavy             Int      @default(300)
  showPersonalizedPlan     Boolean  @default(true)
  termsContentHtml         String   @default("")
  privacyContentHtml       String   @default("")
  dataProcessingContentHtml String  @default("")
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@index([createdAt])
}

model UserConsent {
  id              String    @id @default(uuid())
  userId          String    @unique
  termsAccepted   DateTime
  privacyAccepted DateTime
  dataProcessing  DateTime
  marketing       DateTime?
  version         String
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  User            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model EmailTemplate {
  id              String   @id @default(uuid())
  key             String   @unique
  name            String
  description     String?
  subjectTemplate String
  bodyTemplate    String
  textTemplate    String
  availableTokens String[]
  enabled         Boolean  @default(true)
  isSystem        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([key])
  @@index([enabled])
}

model UserGoals {
  id                   String   @id @default(uuid())
  userId               String   @unique
  currentWeightKg      Float?
  targetWeightKg       Float?
  heightCm             Float?
  dailyCaloriesKcal    Int?
  proteinGrams         Float?
  carbGrams            Float?
  fatGrams             Float?
  waterIntakeMl        Int?
  dailyStepsTarget     Int?
  weeklyWorkoutMinutes Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserPreference {
  id                String   @id @default(uuid())
  userId            String   @unique
  weightUnit        String   @default("lbs")
  measurementUnit   String   @default("inches")
  dateFormat        String   @default("MM/dd/yyyy")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model QuestionnaireBundle {
  id          String   @id @default(uuid())
  cohortId    String   @unique
  bundleJson  Json     // SurveyJS JSON schema with all 5 weeks
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  cohort      Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@index([cohortId])
}

model WeeklyQuestionnaireResponse {
  id          String   @id @default(uuid())
  userId      String
  cohortId    String
  weekNumber  Int      // 1-5
  responseJson Json    // SurveyJS response data
  status      String   @default("in_progress") // "in_progress" or "completed"
  submittedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cohort      Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@unique([userId, cohortId, weekNumber])
  @@index([userId])
  @@index([cohortId])
  @@index([cohortId, weekNumber])
  @@index([status])
}

enum Role {
  CLIENT
  COACH
  ADMIN
}
