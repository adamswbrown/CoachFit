generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model CoachInvite {
  id        String   @id @default(uuid())
  email     String
  coachId   String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@unique([email, coachId])
}

model Cohort {
  id            String               @id @default(uuid())
  name          String
  coachId       String
  createdAt     DateTime             @default(now())
  User          User                 @relation(fields: [coachId], references: [id], onDelete: Cascade)
  invites       CohortInvite[]
  memberships   CohortMembership[]
  CheckInConfig CohortCheckInConfig?
}

model CohortInvite {
  id        String   @id @default(uuid())
  email     String
  cohortId  String
  createdAt DateTime @default(now())
  Cohort    Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@unique([email, cohortId])
}

model CohortMembership {
  userId   String
  cohortId String
  Cohort   Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, cohortId])
  @@index([userId])
  @@index([cohortId])
}

model Entry {
  id     String   @id @default(uuid())
  userId String
  date   DateTime @db.Date

  // Core fields (now optional)
  weightLbs Float?
  steps     Int?
  calories  Int?

  // Height field (for BMI calculation)
  heightInches Float?

  // Phase 2: Additional optional fields
  sleepQuality    Int? // 1-10 scale (perceived sleep quality)
  perceivedEffort Int? // 1-10 scale (RPE: Rate of Perceived Exertion/fatigue)
  notes           String? @db.Text // Free-form notes (client perspective)

  // Phase 3: Custom coach prompts (stored as JSONB for flexibility)
  customResponses Json? // { "custom1": 7, "custom2": "Felt strong today" }

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@index([date])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                 String             @id @default(uuid())
  email              String             @unique
  name               String?
  image              String?
  passwordHash       String?
  roles              Role[]             @default([CLIENT])
  isTestUser         Boolean            @default(false)
  emailVerified      DateTime?
  createdAt          DateTime           @default(now())
  invitedByCoachId   String?
  onboardingComplete Boolean            @default(false)
  Account            Account[]
  CoachInvite        CoachInvite[]
  Cohort             Cohort[]
  CohortMembership   CohortMembership[]
  Entry              Entry[]
  Session            Session[]
  CoachNotes         CoachNote[]        @relation("CoachNotes")
  ClientNotes        CoachNote[]        @relation("ClientNotes")
  AdminActions       AdminAction[]      @relation("AdminActions")
  User               User?              @relation("UserToUser", fields: [invitedByCoachId], references: [id])
  other_User         User[]             @relation("UserToUser")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model CoachNote {
  id        String   @id @default(uuid())
  coachId   String
  clientId  String
  weekStart DateTime @db.Date // Monday of week (for weekly reviews)
  noteDate  DateTime @db.Date // Date when the note was recorded (coach-specified)
  note      String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coach  User @relation("CoachNotes", fields: [coachId], references: [id], onDelete: Cascade)
  client User @relation("ClientNotes", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([coachId, clientId, weekStart]) // Keep for weekly notes
  @@index([coachId, clientId])
  @@index([noteDate]) // Index for chronological queries
}

model CohortCheckInConfig {
  id                String   @id @default(uuid())
  cohortId          String   @unique
  enabledPrompts    String[] // Array of prompt keys: ["sleepQuality", "perceivedEffort", "notes", "custom1"]
  customPrompt1     String? // Coach-defined prompt label (e.g., "How was your energy?")
  customPrompt1Type String? // "scale" | "text" | "number"
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  cohort Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@index([cohortId])
}

// Admin Insights (auto-generated)
model AdminInsight {
  id          String    @id @default(uuid())
  entityType  String // "user" | "coach" | "cohort" | "system"
  entityId    String
  insightType String // "trend" | "anomaly" | "opportunity" | "alert"
  category    String // "engagement" | "capacity" | "performance" | "health"
  title       String
  description String    @db.Text
  severity    String    @default("info") // "info" | "warning" | "error" | "success"
  priority    String    @default("green") // "red" | "amber" | "green"
  actionable  Boolean   @default(true)
  metadata    Json? // Additional context data
  createdAt   DateTime  @default(now())
  expiresAt   DateTime? // Optional expiration for temporary insights

  @@index([entityType, entityId])
  @@index([priority, createdAt])
  @@index([insightType, severity])
  @@index([createdAt])
}

// Attention Scores (calculated)
model AttentionScore {
  id           String    @id @default(uuid())
  entityType   String // "user" | "coach" | "cohort" | "system"
  entityId     String
  priority     String // "red" | "amber" | "green"
  score        Int // 0-100
  reasons      String[] // Array of reason strings
  metadata     Json? // Additional scoring context
  calculatedAt DateTime  @default(now())
  expiresAt    DateTime? // Optional expiration for recalculated scores

  @@unique([entityType, entityId])
  @@index([priority, score])
  @@index([calculatedAt])
}

// Admin Actions (audit trail)
model AdminAction {
  id         String   @id @default(uuid())
  adminId    String
  actionType String // "user_updated" | "coach_assigned" | "cohort_created" | "insight_acted_on"
  targetType String // "user" | "coach" | "cohort" | "insight" | "system"
  targetId   String?
  details    Json? // Additional action details
  reason     String?  @db.Text
  insightId  String? // Optional reference to insight that triggered action
  createdAt  DateTime @default(now())

  admin User @relation("AdminActions", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([actionType])
  @@index([createdAt])
  @@index([insightId])
}

enum Role {
  CLIENT
  COACH
  ADMIN
}
